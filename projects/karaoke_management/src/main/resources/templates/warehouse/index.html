<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head th:insert="layouts/layout.html::header"></head>
<title>Stock</title>
</head>
<body>
	<div th:replace="layouts/layout.html::nav"></div>
	<br />
	<div class="container">
		<ul class="nav nav-tabs" id="myTab" role="tablist">
			<li class="nav-item"><a class="nav-link active" id="stock-tab"
				data-toggle="tab" href="#stockTab" role="tab"
				aria-controls="stockTab" aria-selected="true">Stock</a></li>
			<li class="nav-item"><a class="nav-link" id="product-tab"
				data-toggle="tab" href="#productTab" role="tab"
				aria-controls="productTab" aria-selected="false">Product</a></li>
		</ul>
		<div class="tab-content" id="myTabContent">
			<div class="tab-pane fade show active" id="stockTab" role="tabpanel"
				aria-labelledby="stock-tab">
				<p></p>
				<div class="row">
					<div class="col">
						<h3>
							Stock Information <span class="badge badge-secondary"
								th:utext="${warehouse.packages.size()}"></span>
						</h3>
					</div>
					<div class="col-1">
						<button onclick="openModal('stock', undefined, 'Create', true)"
							class="btn btn-success float-right" data-toggle="tooltip"
							title="Add">
							<i class="fa fa-plus"></i>
						</button>
					</div>
				</div>
				<div class="row">
					<div class="col">
						<div class="table-reponsive h-100">
							<table class="table table-hover table-stripped" id="stock-tb">
								<thead>
									<tr>
										<th>#</th>
										<th>Package Code</th>
										<th>Products</th>
										<th>Supplier Name</th>
										<th>Entry Date</th>
										<th>Status</th>
										<th>Actions</th>
									</tr>
								</thead>
								<tbody>
									<tr th:each="package, state : ${warehouse.packages}">
										<td th:utext="${state.count}"></td>
										<td th:utext="${package.code}"></td>
										<td><th:block th:each="product : ${package.products}">
												<button th:inline="text" class="btn btn-primary btn-sm">
													[[${product.name}]] <span class="badge badge-light"
														th:utext="${product.quantity}"></span>
												</button>
											</th:block></td>
										<td th:utext="${package.supplier.name}"></td>
										<td th:utext="${package.createdAt}"></td>
										<td>
											<!-- PAID = SUCCESS | DEPT = DANGER --> <span
											class="badge badge-primary" th:utext="${package.status}"></span>
										</td>
										<td>
											<button class="btn btn-sm btn-secondary"
												th:attr="onclick='openEditableModal(\'' + ${package.getJsonObject()} + '\');'"
												data-toggle="tooltip" title="Edit">
												<i class="fa fa-edit"></i>
											</button>
											<button
												th:attr="onclick='confirmModal(`Do you sure to delete ' + ${package.code} + '`, \'' + ${package.id} + '\', `delete`);'"
												class="btn btn-sm btn-danger" data-toggle="tooltip"
												title="Delete">
												<i class="fa fa-trash"></i>
											</button>
											<button
												th:attr="onclick='confirmModal(`Do you sure to unactive ' + ${package.code} + '`, \'' + ${package.id} + '\', `unactive`);'"
												class="btn btn-sm btn-warning" data-toggle="tooltip"
												title="Unactive">
												<i class="fa fa-lock"></i>
											</button>
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
			<div class="tab-pane fade" id="productTab" role="tabpanel"
				aria-labelledby="product-tab">
				<p></p>
				<div class="row">
					<div class="col">
						<h3>
							Product Information <span class="badge badge-secondary"
								th:utext="${warehouse.products.size()}"></span>
						</h3>
					</div>
				</div>
				<div class="row">
					<div class="col">
						<div class="table-reponsive">
							<table class="table table-hover" id="product-tb">
								<thead>
									<tr>
										<th>#</th>
										<th>Name</th>
										<th>Image</th>
										<th>Quantity</th>
										<th>Unit</th>
										<th>Bought Price</th>
										<th>Sell Price</th>
										<th>Type</th>
										<th>Expired At</th>
										<th>Package Code</th>
									</tr>
								</thead>
								<tbody>
									<tr th:each="product, state : ${warehouse.products}">
										<td th:utext="${state.count}" class="align-middle"></td>
										<td th:utext="${product.name}" class="align-middle"></td>
										<td><img th:src="${product.image}" width="60" /></td>
										<td th:utext="${product.quantity}" class="align-middle"></td>
										<td th:utext="${product.unit}" class="align-middle"></td>
										<td th:utext="${product.boughtPrice}" class="align-middle"></td>
										<td th:utext="${product.sellPrice}" class="align-middle"></td>
										<td class="align-middle"><span
											class="badge badge-primary" th:utext="${product.type}"></span></td>

										<td th:utext="${product.expiredAt}" class="align-middle"></td>
										<td th:utext="${product.packagez.code}" class="align-middle"></td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div th:replace="layouts/layout.html::stock"></div>
	<script>
		
		var defaultModalAddContent = undefined;
		
		$(document).ready(function() {

			// config Stock DataTable
			$("#stock-tb").DataTable({
				"pageLength" : 6
			});
			$("#product-tb").DataTable({
				"pageLength" : 6
			});
			
			// storage default content Modal add
			defaultModalAddContent = $(".modal-body .container").html();
			
			// config tooltip
			$('[data-toggle="tooltip"]').tooltip();
		});
		
		function dupplicateInput(e) {
		    let dupplicateRow = `<div class="row pt-1">
		                            <div class="col-2 pr-0">
		                                <input type="text" class="form-control product" />
		                            </div>
		                            <div class="col pr-0">
		                                <input type="text" class="form-control product" />
		                            </div>
		                            <div class="col-2 pr-0">
		                                <input type="date" class="form-control product" onchange="getLastExpiredDate()"/>
		                            </div>
		                            <div class="col pr-0">
		                                <select class="form-control product">
		                                    <option value="FOOD">Food</option>
		                                    <option value="DRINK">Drink</option>
		                                </select>
		                            </div>
		                            <div class="col pr-0">
		                                <input type="text" class="form-control product" />
		                            </div>
		                            <div class="col pr-0">
		                                <input type="text" class="form-control product boughtPrice" onchange="addPrice('boughtPrice')"/>
		                            </div>
		                            <div class="col pr-0">
		                                <input type="text" class="form-control product sellPrice" onchange="addPrice('sellPrice')"/>
		                            </div>
		                            <div class="col p-0 d-flex justify-content-around pt-1">
		                            	<button class="btn btn-primary btn-sm text-light"
		                            		onclick="uploadProductImage(this)">
		                            		<i class="fas fa-images"></i>
		                            	</button>
		                            	<input type="file" class="d-none p-file" />
			                            <button type="button" class="btn btn-danger btn-sm"
											onclick="removeDupplicateInputs(this)">
											<i class="fa fa-trash"></i>
										</button>
		                            </div>
		                        </div>`; 
		    $("div.modal-body div.container").append(dupplicateRow);
		}
		function removeDupplicateInputs(ele) {
			ele.parentNode.parentNode.remove();
			addPrice('sellPrice');
			addPrice('boughtPrice');
		}
		
		function getLastExpiredDate() {
			
			let productsExp = $(`input[type="date"]`).not("#m_expAt").toArray().map(x => x.value);
			productsExp = productsExp.sort((a, b) => new Date(a) - new Date(b)); // sort asc
			$("#m_expAt").val(productsExp.slice(-1).toString());
		}
		function addPrice(id) {
			
			let price = $(`.${id}`).toArray().reduce((total, ele) => total + parseFloat(ele.value), 0);
			$(`#m_${id}`).val(price);
		}
		function addPackage(e) {
			
			let products = $(".product");
			var productsForm = [];
			// check empty field in products
			// check empty field in package
			// TODO...
			for (let i = 0; i < products.length; i += 7) {
				let productName = products[i].value;
				let quantity = products[i+1].value;
				let expiredAt = products[i+2].value;
				let type = products[i+3].value;
				let unit = products[i+4].value;
				let boughtPrice = products[i+5].value;
				let sellPrice = products[i+6].value;
				let image = "";
				productsForm.push({productName, quantity, expiredAt, type, unit, boughtPrice, sellPrice, image});
			}
			let packageCode = $("#m_packageCode").val();
			let supplierId = $("#m_supplier").val();
			let status = $("#m_status").val();
			let expAt = $("#m_expAt").val();
			let boughtPrice = $("#m_boughtPrice").val();
			let sellPrice = $("#m_sellPrice").val();
			
			let packagez = {packageCode, expAt, boughtPrice, sellPrice, supplierId, status};
			
			sendAjaxRequest(packagez, productsForm);
		}
		function sendAjaxRequest(packagez, productsForm) {
			
			let bodyData = {
					"package": packagez,
					"products": productsForm
			};
			
			fetch(`${window.location.origin}/warehouse/add`, {
				method: "POST",
				body: JSON.stringify(bodyData)
			})
			.then(res => res.text())
			.then(res => {
				window.location.reload();
			});
		}
		
		
		function uploadProductImage(btnClicked) {
			btnClicked.nextElementSibling.click();
		}
		
		function setUpDefaultModal() {
			$(".modal-body .container").html(defaultModalAddContent);
		}
		
		function openEditableModal(jsonObjectStr) {
			
			let packagez = JSON.parse(jsonObjectStr);
			$("#m_packageCode").val(packagez.code);
			$("#m_supplier").val(packagez.supplier.id);
			$("#m_status").val(packagez.status);
			$("#m_boughtPrice").val(packagez.boughtPrice);
			$("#m_sellPrice").val(packagez.sellPrice);
			
			$("#m_submit").val("Update");
			$("#stock").modal({show: true});
		}
		
	</script>
<body th:insert="layouts/layout.html::footer"></body>
</body>

</html>